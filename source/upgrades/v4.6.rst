##############
La version 4.6
##############


================================
Les nouveautés de la version 4.6
================================

* Compatibilité PHP7
* Ajout de la liste des scripts disponibles dans le formulaire de création/modifcation de widget

==============================================
Mettre à niveau depuis openMairie 4.5 vers 4.6
==============================================

Faire une génération complète
-----------------------------

Des modifications du générateur nécessite une génération complète pour prendre en compte ces modifications.


Gestion de la suppression des scripts ``pdf/pdf*.php``
------------------------------------------------------

Le répertoire ``pdf/`` a été supprimé du framework. Il est nécessaire de vérifier dans l'applicatif à mettre à niveau tous les appels existants aux scripts présents dans ce répertoire. Si des appels existent, deux méthodes sont disponibles pour obtenir un fonctionnement identique au fonctionnement de la version 4.5 :


Méthode n°1 (non conseillée)
............................

Plus simple mais ne permet pas de profiter des bénéfices de la suppression du répertoire ``pdf/``.

- Récupérer les scripts actuels présents dans le répertoire ``pdf/`` du tag 4.5.0 https://adullact.net/scm/viewvc.php/openmairie/openmairie_exemple/tags/4.5.0/pdf/
- Déposer les scripts nécessaires dans le répertoire ``app/`` de l'applicatif.
- Remplacer le chemin vers ces scripts dans tous les appels existants dans l'applicatif.


Méthode n°2 (conseillée)
........................

Moins simple mais permet de profiter des bénéfices de la suppression du répertoire pdf/.

- Identifier les cas d'utilisation qui génèrent des éditions.
- Intégrer dans une vue/action sur l'objet concerné par l'édition.

  .. code-block :: php

   <?php
        ...

        function init_class_actions() {
            ...
            $this->class_actions[201] = array(
                "identifier" => "edition-pdf",
                "view" => "view_edition",
                "portlet" => array(
                    "type" => "action-blank",
                    "libelle" => _("Édition PDF"),
                ),
                "permission_suffix" => "edition",
            );
            ...
        }

        function view_edition() {
            $this->checkAccessibility();
            $pdfedition = $this->compute_pdf_output(
                "lettretype",
                "objet_de_ma_lettre_type"
            );
            $this->expose_pdf_output(
                $pdfedition["pdf_output"], 
                "mon-fichier-".date('YmdHis').".pdf"
            );
        }

        ...
    ?>


Corriger les prototypes des méthodes surchargées s'ils diffèrent de leurs parents
---------------------------------------------------------------------------------

Afin d'assurer la compatibilité du code avec la version 7 de PHP, il est nécessaire d'effectuer cette modification.



Suppression du script ``scr/directory.php``
-------------------------------------------

Depuis la version 4.5.0 du framework la vue permettant de synchroniser les utilisateurs avec un annuaire a été déplacée dans une vue de la classe ``om_utilisateur``, du coup elle est accessible directement depuis l'URL ``scr/form.php?obj=om_utilisateur&idx=0&action=11``. La mise à niveau consiste au remplacement des appels au script ``scr/directory.php`` par cette URL.


Suppression du script ``scr/dashboard_composer.php``
----------------------------------------------------

Depuis la version 4.5.0 du framework la vue permettant de composer le tableau de bord de chaque profil a été déplacée dans une vue de la classe ``om_dashboard``, du coup elle est accessible directement depuis l'URL ``scr/form.php?obj=om_dashboard&idx=0&action=4``. La mise à niveau consiste au remplacement des appels au script ``scr/dashboard_composer.php`` par cette URL.

